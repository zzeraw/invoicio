# AGENTS.md

## 1. Описание проекта

Проект - личный кабинет для работы со счетами:
- Ведение клиентов и их реквизитов.
- Ведение услуг.
- Создание счетов и позиций счета (описание, часы, ставка, сумма).
- Хранение счетов.
- Генерация PDF счета по шаблону (номер, дата, валюта, итоги, НДС/без НДС).
- Скачивание PDF счета.

Стек:
- Backend: Go (HTTP JSON API)
- Frontend: React
- База данных: PostgreSQL
- Среда разработки: Docker + Docker Compose
- CI/CD: GitHub Actions или GitLab CI

Цель:
- Сделать минимальный, но качественный v1.
- Сохранить контроль над архитектурой и качеством кода.
- Параллельно изучить Go и React.

Структура репозитория:
- backend/
- frontend/
- infra/
- docs/
- Makefile


## 2. Границы функциональности (v1)

Обязательно:
- Аутентификация: логин/пароль, cookie-based session.
- Сущности: Клиенты, Услуги, Счета, Позиции счета, PDF счета.
- Страницы UI: вход, список счетов, создание/редактирование счета, просмотр/скачивание PDF.
- Нумерация счетов: детерминированная и атомарная.
- Деньги: без float в бизнес-логике.

Не делать в v1 (только если явно попрошу):
- Мультипользовательская система и роли.
- Публичный API для сторонних систем.
- Отправка счетов по email.
- Платежи и интеграции с банками.
- Сложная аналитика.
- Kubernetes.


## 3. Нефункциональные требования

Качество кода:
- Go: gofmt, goimports, golangci-lint.
- React: eslint, prettier.
- Понятная структура каталогов.
- Тесты на ключевую бизнес-логику (итоги счета, нумерация, авторизация).

Безопасность:
- Хеширование паролей (bcrypt или argon2).
- httpOnly cookies для сессий.
- Не хранить токены в localStorage.
- Валидация входных данных.

Целостность данных:
- Транзакции для операций со счетами и позициями.
- Снимок итогов счета хранится в таблице invoices.
- После выставления счета (issued) его бизнес-данные считаются неизменяемыми.


## 4. Архитектура backend

Слои:
- Handler / Controller - HTTP, валидация, ответы, auth.
- Service - бизнес-логика.
- Repository - SQL и работа с БД.
- DB - PostgreSQL.

Правила:
- Деньги: int64 в минимальных единицах или NUMERIC.
- float запрещен.
- Время: UTC.
- Формат ошибок API единый.

Статусы счета:
- Минимум: draft, issued, paid.
- Номер присваивается при переводе в issued.

Миграции:
- Использовать инструмент миграций.
- Миграции должны быть безопасны для деплоя (предпочтительно forward-only).


## 5. Архитектура frontend

- React SPA.
- Минимальный state management.
- API клиент с обработкой 401 (редирект на /login).
- Cookie-based auth.
- Аккуратный минималистичный UI.


## 6. Workflow разработки

Команды:
- make up / down
- make lint
- make test
- make fmt

Docker:
- docker compose поднимает DB и API.
- Healthchecks обязательны.

Тестирование:
- Backend: unit + интеграционные тесты.
- Frontend: минимум smoke test или описанный ручной сценарий.


## 7. Правила работы Codex

Общие:
- Работать итеративно, маленькими шагами.
- Не добавлять функциональность "на будущее".
- При неясностях явно писать допущения в квадратных скобках.

Формат ответа:
1. Цель шага.
2. Критерии готовности.
3. Список изменяемых файлов.
4. Код.
5. Команды запуска и проверки.
6. Риски и как они учтены.
7. Альтернативы (плюсы/минусы и последствия).

Ограничения:
- Менять только файлы текущего шага.
- Изменения должны быть компактными и проверяемыми.
- Не переписывать проект целиком без явного запроса.

Стиль:
- Читаемый код важнее "умного".
- Последовательные имена.
- Комментарии только для неочевидных решений.


## 8. Журнал решений (append-only)

Фиксировать важные архитектурные решения:
- Дата
- Решение
- Причина
- Последствия (1-2 шага вперед)


## 9. Примеры и материалы

Если есть:
- docs/examples/ - примеры счетов и PDF.
- docs/api.md - описание API или OpenAPI.
